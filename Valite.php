<?php

define('WORD_WIDTH',7);
define('WORD_HIGHT',10);
define('OFFSET_X',1);
define('OFFSET_Y',0);
define('WORD_SPACING',3);
include ('bmp.php');
class valite
{
	public function setImage($Image)
	{
		$this->ImagePath = $Image;
	}
	public function getData()
	{
		return $data;
	}
	public function getResult()
	{
		return $DataArray;
	}
	public function getHec()
	{
		$res = imagecreatefrombmp($this->ImagePath);
		$size = getimagesize($this->ImagePath);
		$data = array();
		for($i=0; $i < $size[1]; ++$i)
		{
			for($j=0; $j < $size[0]; ++$j)
			{
				$rgb = imagecolorat($res,$j,$i);
				$rgbarray = imagecolorsforindex($res, $rgb);
				if($rgbarray['red'] < 125 || $rgbarray['green']<125
				|| $rgbarray['blue'] < 125)
				{
					$data[$i][$j]=1;
				}else{
					$data[$i][$j]=0;
				}
			}
		}
		$this->DataArray = $data;
		$this->ImageSize = $size;
	}
	public function run()
	{
		$result="";
		// 查找4个数字
		$data = array("","","","");
		for($i=0;$i<4;++$i)
		{
			$x = ($i*(WORD_WIDTH+WORD_SPACING))+OFFSET_X;
			$y = OFFSET_Y;
			for($h = $y; $h < (OFFSET_Y+WORD_HIGHT); ++ $h)
			{
				for($w = $x; $w < ($x+WORD_WIDTH); ++$w)
				{
					$data[$i].=$this->DataArray[$h][$w];
				}
			}

		}

		// 进行关键字匹配
		foreach($data as $numKey => $numString)
		{
			$max=0.0;
			$num = 0;
			foreach($this->Keys as $key => $value)
			{
				$percent=0.0;
				similar_text($value, $numString,$percent);
				if(intval($percent) > $max)
				{
					$max = $percent;
					$num = $key;
					if(intval($percent) > 95)
						break;
				}
			}
			$result.=$num;
		}
		$this->data = $result;
		// 查找最佳匹配数字
		return $result;
	}

	public function Draw()
	{
		for($i=0; $i<$this->ImageSize[1]; ++$i)
		{
	        for($j=0; $j<$this->ImageSize[0]; ++$j)
		    {
			    echo $this->DataArray[$i][$j];
	        }
		    echo "\n";
		}
	}
	public function __construct()
	{
		$this->Keys = array(
				'A'=>'0001000000100000101000010100001010000101000111110010001001000101110111',
				'B'=>'1111110010000101000010100011011110001000100100001010000101000011111110',
				'C'=>'0011111010000110000011000000100000010000001000000100000101000100011100',
				'D'=>'1111100010001001000010100001010000101000010100001010000101000101111100',
				'E'=>'1111110010000101001000100100011110001001000100100010000001000011111110',
				'F'=>'1111110010000101001000100100011110001001000100100010000001000001110000',
				//'G'=>'0011110010001010000101000000100000010000001000111100001001000100011100',
				'H'=>'1110111010001001000100100010011111001000100100010010001001000101110111',
				'I'=>'0111110000100000010000001000000100000010000001000000100000010000111110',
				'K'=>'1110111010001001001000101000011100001010000100100010010001000101110111',
				'L'=>'1110000010000001000000100000010000001000000100000010000001000011111111',
				'M'=>'1110111011011001101100110110010101001010100101010010101001010101101011',
				'N'=>'1110111011001001100100101010010101001010100100110010011001001101110010',
				'O'=>'0011100010001010000011000001100000110000011000001100000101000100011100',
				'P'=>'1111110010000101000010100001011111001000000100000010000001000001110000',
				'Q'=>'0011100010001010000011000001100000110000011000001101100101001100011100',
				'R'=>'1111100010001001000100100010011110001010000100100010010001000101110011',
				'S'=>'0011111010000101000010100000001100000001100000001010000101000010111110',
				'T'=>'1111111100100100010000001000000100000010000001000000100000010000011100',
				'U'=>'1110111010001001000100100010010001001000100100010010001001000100011100',
				'V'=>'1110111010001001000100100010001010000101000010100001010000010000001000',
				'W'=>'1101011010101001010100101010010101001101100010100001010000101000010100',
				'X'=>'1110111010001000101000010100000100000010000010100001010001000101110111',
				'Y'=>'1110111010001001000100010100001010000010000001000000100000010000011100',
				//'Z'=>'0111110100010000001000001000000100000100000010000010000001000101111110',
				'0'=>'0111100100001010000101011010101101010110101011010100001010000100111100',
				'1'=>'0001000011100000010000001000000100000010000001000000100000010000111110',
				'2'=>'0111100100001010000100000010000010000010000010000010000010000101111110',
				'3'=>'0111100100001010000100000100001100000001000000010100001010000100111100',
				'4'=>'0000100000110000011000010100010010010001001111111000010000001000011110',
				'5'=>'1111110100000010000001011100110011000000100000010100001010000100111100',
				'6'=>'0011100010001010000001000000101110011000101000010100001010000100111100',
				'7'=>'1111110100010010001000001000001100000100000010000001000000100000010000',
				'8'=>'0111100100001010000101000010011110001001001000010100001010000100111100',
				'9'=>'0011100010001001000010100001010001100111010000001000000100100100001100',
	);
	}
	protected $ImagePath;
	protected $DataArray;
	protected $ImageSize;
	protected $data;
	protected $Keys;
	protected $NumStringArray;

}
?>
